name: E2E — Playwright (post-deploy)

on:
  workflow_run:
    workflows: ["CD — Kubernetes Deploy (Helm)"]
    types: [completed]

  # Allow manual runs for diagnostics or ad-hoc verification
  workflow_dispatch: {}

jobs:
  run-e2e:
    name: Run E2E Tests After Deploy (self-hosted)
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    # Use a self-hosted runner that has network access to your Cloudflared tunnel
    # Replace the labels below with your runner's labels if different.
    runs-on: arc-runnerset-instance
    env:
      # Default staging URL; override if your deploy emits a specific host
      E2E_BASE_URL: https://shop.kunlecreates.org
      CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
      CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install e2e deps
        working-directory: e2e
        run: |
          if [ -f package-lock.json ]; then npm ci --include=dev; else npm install --include=dev; fi

      - name: Install Playwright browsers
        working-directory: e2e
        run: npx playwright install --with-deps

      - name: Verify E2E host reachable (supports optional service token)
        working-directory: e2e
        run: |
          set -euo pipefail
          echo "Checking E2E host: ${E2E_BASE_URL}"

          # First, try an unauthenticated request
          unauth_status=$(curl -sS -o /dev/null -w "%{http_code}" "${E2E_BASE_URL}" || echo "000")
          echo "Unauthenticated HTTP status: ${unauth_status}"
          if [[ "${unauth_status}" =~ ^[23] ]]; then
            echo "E2E host reachable (unauthenticated, status ${unauth_status})"
            exit 0
          fi

          # If the host is protected (401/403) and a service token is provided, try an authenticated request.
          status=$(curl -sS -o /dev/null -w "%{http_code}" \
            -H "CF-Access-Client-Id: ${CF_ACCESS_CLIENT_ID}" \
            -H "CF-Access-Client-Secret: ${CF_ACCESS_CLIENT_SECRET}" \
            "${E2E_BASE_URL}")

          echo "HTTP status: ${status}"

          if [[ ! "${status}" =~ ^[23] ]]; then
            echo "E2E endpoint unreachable via Cloudflare Access"
            exit 1
          fi
      
      # Cloudflare Access: do not exchange service token for a cookie.
      # Cloudflare Access expects the `CF-Access-Client-Id` and
      # `CF-Access-Client-Secret` headers to be sent with requests.
      # Playwright will be configured to add those headers when the
      # corresponding secrets are available in the environment.

      - name: Run Playwright E2E
        working-directory: e2e
        env:
          CI: true
        run: |
          npx playwright test --config=playwright.config.ts --project=chromium

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-playwright-report
          path: |
            e2e/test-results/playwright-report/**
            e2e/playwright-report/**
            e2e/test-results/**

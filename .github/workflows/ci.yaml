name: CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  build-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [ user-service, product-service, order-service, notification-service, frontend ]
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        if: matrix.service == 'user-service' || matrix.service == 'order-service'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Set up Node
        if: matrix.service == 'product-service' || matrix.service == 'frontend'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Set up Python
        if: matrix.service == 'notification-service'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install & Test (Java)
        if: matrix.service == 'user-service' || matrix.service == 'order-service'
        working-directory: services/${{ matrix.service }}
        run: ./mvnw -q -DskipTests package || mvn -q -DskipTests package
      - name: Install & Test (Node)
        if: matrix.service == 'product-service' || matrix.service == 'frontend'
        working-directory: services/${{ matrix.service }}
        run: |
          npm install
          if [ "${{ matrix.service }}" = "product-service" ]; then npm run build; fi
          if [ "${{ matrix.service }}" = "frontend" ]; then npm run build; fi
      - name: Install & Test (Python)
        if: matrix.service == 'notification-service'
        working-directory: services/${{ matrix.service }}
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt
      - name: Build Docker Image
        run: |
          docker build -t ghcr.io/${{ github.repository }}/$SERVICE:$(echo $GITHUB_SHA | cut -c1-7) .
        env:
          SERVICE: ${{ matrix.service }}
      - name: Summary
        run: echo "Built $SERVICE"
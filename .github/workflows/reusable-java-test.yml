name: Reusable Java Test

on:
  workflow_call:
    inputs:
      module_path:
        required: true
        type: string
      maven_goal:
        required: false
        type: string
        default: 'test'
      jdk_version:
        required: false
        type: string
        default: '21'
      maven_args:
        required: false
        type: string
        default: ''
      run_docker_diagnostics:
        required: false
        type: boolean
        default: false

jobs:
  test:
    name: Java module tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.jdk_version }}

      - name: Restore Maven cache (~/.m2/repository)
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      - name: Make module mvnw executable (if present)
        run: |
          if [ -f "${{ inputs.module_path }}/mvnw" ]; then
            chmod +x "${{ inputs.module_path }}/mvnw" || true
          fi

      - name: Ensure test-utils (build & install; add diagnostics)
        run: |
          echo "Ensuring test-utils is installed into local Maven repo ($HOME/.m2/repository)"
          if [ -f ./services/test-utils/pom.xml ]; then
            echo "Found test-utils sources; building and installing (will overwrite existing)"
            # Prefer repo mvnw, fallback to module wrapper or system mvn to ensure consistent install
            if [ -f ./mvnw ]; then
              chmod +x ./mvnw || true
              ./mvnw -B -DskipTests -Dmaven.repo.local="$HOME/.m2/repository" -f services/test-utils/pom.xml install
            elif [ -f ./services/test-utils/mvnw ]; then
              chmod +x ./services/test-utils/mvnw || true
              ./services/test-utils/mvnw -B -DskipTests -Dmaven.repo.local="$HOME/.m2/repository" -f services/test-utils/pom.xml install
            else
              mvn -B -DskipTests -Dmaven.repo.local="$HOME/.m2/repository" -f services/test-utils/pom.xml install
            fi
            echo "Installed test-utils. Verifying contents in local repo:"
            ls -la "$HOME/.m2/repository/org/kunlecreates/test-utils/" || true
            if [ -f "$HOME/.m2/repository/org/kunlecreates/test-utils/0.1.0/test-utils-0.1.0.jar" ]; then
              echo "Jar exists; showing listing and checksum"
              jar -tf "$HOME/.m2/repository/org/kunlecreates/test-utils/0.1.0/test-utils-0.1.0.jar" | sed -n '1,200p' || true
              sha256sum "$HOME/.m2/repository/org/kunlecreates/test-utils/0.1.0/test-utils-0.1.0.jar" || true
            else
              echo "Warning: test-utils jar still missing after install"
            fi
          else
            echo "test-utils sources not present in checkout; skipping build/install"
          fi

      - name: 'Pre-run diagnostics: module test classpath and dependency tree'
        run: |
          echo "Listing installed test-utils in local repo (if any):"
          ls -la "$HOME/.m2/repository/org/kunlecreates/test-utils" || true
          echo "Show dependency:tree for module (test scope) to verify test-utils presence"
          mvn -B -f "${{ inputs.module_path }}" dependency:tree -Dscope=test || true

      - name: Docker diagnostics (optional)
        if: ${{ inputs.run_docker_diagnostics }}
        run: |
          echo "Docker diagnostics"
          docker --version || true
          docker info || true

      - name: Run Maven goal for module (uses centralized helper)
        run: |
          chmod +x ./scripts/run_maven_module.sh || true
          # pass maven_args if provided
          if [ -n "${{ inputs.maven_args }}" ]; then
            ./scripts/run_maven_module.sh "${{ inputs.module_path }}" "${{ inputs.maven_goal }}" ${{ inputs.maven_args }}
          else
            ./scripts/run_maven_module.sh "${{ inputs.module_path }}" "${{ inputs.maven_goal }}"
          fi

      - name: Prepare artifact name
        id: prepare-artifact
        run: |
          module_path="${{ inputs.module_path }}"
          # replace forward slashes with hyphens for filesystem-safe artifact names
          safe_name="${module_path//\//-}-maven-artifacts"
          echo "artifact_name=${safe_name}" >> $GITHUB_OUTPUT

      - name: Upload Maven test artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.prepare-artifact.outputs.artifact_name }}
          path: |
            ${{ inputs.module_path }}/target/failsafe-reports/**
            ${{ inputs.module_path }}/target/surefire-reports/**
            ${{ inputs.module_path }}/target/*.log

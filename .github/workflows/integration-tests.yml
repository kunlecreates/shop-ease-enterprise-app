name: Integration Tests
# Trigger update: touch to force CI re-run (autogenerated change)
# CI trigger: bump timestamp to rerun workflows - 2025-12-06T10:00:00Z

on:
  push:
    # Run on main/master and on CI topic branches used for testing.
    # Add the shared PR branch and a glob for test/* branches so pushes
    # to topics like `test/ci-*` will trigger the workflow.
    branches:
      - main
      - master
      - feat/dev-tests
      - 'test/**'
    # Only run this expensive integration matrix when cross-cutting, shared or infra
    # changes occur. Service-local changes are handled by per-service CI jobs.
    paths:
      - 'services/test-utils/**'
      - '.github/workflows/**'
      - 'scripts/**'
      - 'helm-charts/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'services/test-utils/**'
      - '.github/workflows/**'
      - 'scripts/**'
      - 'helm-charts/**'
  # Allow manual runs for diagnostics or ad-hoc verification
  workflow_dispatch: {}

# Ensure the workflow can read GitHub Packages so we can fetch published test-utils
permissions:
  contents: read
  packages: read
jobs:
  prepare:
    name: Prepare shared test artifacts
    runs-on: ubuntu-latest
    outputs:
      from_registry: ${{ steps.fetch_test_utils.outputs.from_registry }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Write maven settings
        run: |
          bash ./scripts/write_maven_settings.sh "${{ github.actor }}" "${{ secrets.GITHUB_TOKEN }}"

      - id: fetch_test_utils
        name: Try fetching published test-utils from GitHub Packages
        run: |
          set -e
          echo "Attempting to download org.kunlecreates:test-utils:0.1.0 from GitHub Packages into local repo"
          # Instruct Maven to use the GitHub Packages repository when resolving the artifact.
          mvn -B -s $HOME/.m2/settings.xml \
            org.apache.maven.plugins:maven-dependency-plugin:3.5.0:get \
            -Dartifact=org.kunlecreates:test-utils:0.1.0:pom \
            -DremoteRepositories=github::default::https://maven.pkg.github.com/kunlecreates/shop-ease-enterprise-app || true
          mvn -B -s $HOME/.m2/settings.xml \
            org.apache.maven.plugins:maven-dependency-plugin:3.5.0:get \
            -Dartifact=org.kunlecreates:test-utils:0.1.0 \
            -DremoteRepositories=github::default::https://maven.pkg.github.com/kunlecreates/shop-ease-enterprise-app || true
          # Verify artifact and POM presence
          if [ -f "$HOME/.m2/repository/org/kunlecreates/test-utils/0.1.0/test-utils-0.1.0.jar" ] && [ -f "$HOME/.m2/repository/org/kunlecreates/test-utils/0.1.0/test-utils-0.1.0.pom" ]; then
            echo "Downloaded test-utils (jar + pom) from GitHub Packages"
            echo "from_registry=true" >> "$GITHUB_OUTPUT"
          else
            echo "test-utils jar or POM not found in GitHub Packages; will build from source"
            echo "from_registry=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build & install test-utils (only if not fetched)
        run: |
          # Only build/install test-utils from source if it was not fetched from GitHub Packages
          if [ -f "$HOME/.m2/repository/org/kunlecreates/test-utils/0.1.0/test-utils-0.1.0.jar" ]; then
            echo "test-utils already present in local repo; skipping build"
          else
            echo "test-utils not present; building and installing from source"
            mvn -B -f ./services/test-utils/pom.xml install
          fi

      - name: Verify test-utils artifact contents (before upload)
        if: success()
        run: |
          DIR="$HOME/.m2/repository/org/kunlecreates/test-utils"
          if [ -d "$DIR" ]; then
            echo "Listing contents of $DIR"
            ls -al "$DIR" || true
            echo "Checking for marker files"
            find "$DIR" -name "*.lastUpdated" -o -name "_remote.repositories" -print || true
          else
            echo "$DIR does not exist; nothing to list"
          fi

      - name: Clean bad Maven cache entries before upload (prepare)
        if: success()
        run: |
          DIR="$HOME/.m2/repository/org/kunlecreates/test-utils"
          if [ -d "$DIR" ]; then
            echo "Cleaning Maven cache marker files under $DIR"
            find "$DIR" -name "*.lastUpdated" -print -delete || true
            find "$DIR" -name "_remote.repositories" -print -delete || true
          else
            echo "$DIR does not exist; nothing to clean"
          fi

      - name: Upload built test-utils to share with matrix jobs
        if: ${{ success() && steps.fetch_test_utils.outputs.from_registry == 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: test-utils-m2
          path: ~/.m2/repository/org/kunlecreates/test-utils

  service-tests:
    name: Run tests for services
    needs: prepare
    runs-on: ubuntu-latest
    env:
      DOCKER_API_VERSION: '1.52'
    strategy:
      matrix:
        service: [order-service, user-service, product-service, notification-service]
      # Allow running two service matrix jobs concurrently to reduce runtime
      # and the chance that a single service (the first in the list) appears
      # to always run for infra/global changes.
      max-parallel: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup caches
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.cache/pip
          key: ${{ runner.os }}-build-${{ matrix.service }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.service }}-

      - name: Job-level environment setup
        run: |
          # Example: if the service requires local secrets or helper containers,
          # they can be started or environment variables exported here.
          # This block intentionally minimal; extend per-service as needed.
          case "${{ matrix.service }}" in
            order-service|user-service)
              echo "Java service: ensure Docker available for Testcontainers"
              docker --version || true
              ;;
            product-service)
              echo "Product service: no extra setup by default"
              ;;
            notification-service)
              echo "Notification service: may require SMTP test container in future"
              ;;
          esac

      - name: Write maven settings
        run: |
          bash ./scripts/write_maven_settings.sh "${{ github.actor }}" "${{ secrets.GITHUB_TOKEN }}"

      - name: Set up JDK 21 for Java services
        if: ${{ matrix.service == 'order-service' || matrix.service == 'user-service' }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Download built test-utils from prepare job
        if: ${{ needs.prepare.outputs.from_registry == 'false' }}
        uses: actions/download-artifact@v4
        with:
          name: test-utils-m2
          path: ./.m2/repository/org/kunlecreates/test-utils

      - name: Ensure test-utils available in local Maven repo
        run: |
          bash ./scripts/ensure_test_utils.sh "$GITHUB_WORKSPACE"


      - name: Run tests for ${{ matrix.service }}
        run: |
          # test-utils (if provided) should already be installed into ~/.m2 by the previous step
          set -e
          SERVICE_DIR="./services/${{ matrix.service }}"
          echo "Checking $SERVICE_DIR"
          if [ -f "$SERVICE_DIR/pom.xml" ]; then
            echo "Detected Maven service. Running mvn verify (includes integration tests)"
            mvn -B -s $HOME/.m2/settings.xml -U -f "$SERVICE_DIR" -Dapi.version=1.44 verify
          elif [ -f "$SERVICE_DIR/package.json" ]; then
            echo "Detected Node service. Installing and running npm test"
            pushd "$SERVICE_DIR"
            # Prefer npm ci when a lockfile exists, otherwise fall back to npm install
            if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
              npm ci
            else
              npm install
            fi
            npm test --silent || { echo 'npm test failed'; exit 1; }
            popd
          elif [ -f "$SERVICE_DIR/requirements.txt" ] || [ -f "$SERVICE_DIR/pyproject.toml" ]; then
            echo "Detected Python service. Running pytest from service dir"
            set -o pipefail
            # Run tests from inside the service directory so imports like `app` resolve
            pushd "$SERVICE_DIR"
            python3 -m pip install --upgrade pip || echo "pip upgrade failed"
            if [ -f requirements.txt ]; then
              python3 -m pip install -r requirements.txt || echo "pip install returned non-zero (continuing for debug)"
            fi
            # Ensure package imports resolve: include service dir on PYTHONPATH
            export PYTHONPATH="$(pwd)":$PYTHONPATH
            # Diagnostic removed: python sys.path printing was temporary
            # Run pytest with junit xml and capture logs; treat exit code 5 (no tests) as success
            rc=0
            pytest --maxfail=1 --junitxml=pytest-results.xml . > pytest.log 2>&1 || rc=$?
            if [ "$rc" -eq 5 ]; then
              echo "No tests collected for $SERVICE_DIR; continuing."
              rc=0
            fi
            if [ "$rc" -ne 0 ]; then
              echo "pytest failed with exit code $rc"
              cat pytest.log || true
              popd
              exit $rc
            fi
            popd
          else
            echo "No known test runner for $SERVICE_DIR; skipping"
          fi

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-artifacts
          path: |
            services/${{ matrix.service }}/pytest-results.xml
            services/${{ matrix.service }}/pytest.log
            services/${{ matrix.service }}/target/surefire-reports/**


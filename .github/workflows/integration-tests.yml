name: Integration Tests
# Trigger update: touch to force CI re-run (autogenerated change)
# CI trigger: bump timestamp to rerun workflows - 2025-11-21T19:33:00Z

on:
  push:
    branches: [ main, master ]
    # Ignore service folder changes; per-service integration workers will run instead
    paths-ignore:
      - 'services/**'
  pull_request:
    branches: [ main, master ]
    paths-ignore:
      - 'services/**'

jobs:
  prepare:
    name: Prepare shared test artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build & install test-utils
        run: |
          mvn -B -f ./services/test-utils/pom.xml install

      - name: Upload built test-utils to share with matrix jobs
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: test-utils-m2
          path: ~/.m2/repository/org/kunlecreates/test-utils

  service-tests:
    name: Run tests for services
    needs: prepare
    runs-on: ubuntu-latest
    env:
      DOCKER_API_VERSION: '1.52'
    strategy:
      matrix:
        service: [order-service, user-service, product-service, notification-service]
      # Allow running two service matrix jobs concurrently to reduce runtime
      # and the chance that a single service (the first in the list) appears
      # to always run for infra/global changes.
      max-parallel: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup caches
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.cache/pip
          key: ${{ runner.os }}-build-${{ matrix.service }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.service }}-

      - name: Job-level environment setup
        run: |
          # Example: if the service requires local secrets or helper containers,
          # they can be started or environment variables exported here.
          # This block intentionally minimal; extend per-service as needed.
          case "${{ matrix.service }}" in
            order-service|user-service)
              echo "Java service: ensure Docker available for Testcontainers"
              docker --version || true
              ;;
            product-service)
              echo "Product service: no extra setup by default"
              ;;
            notification-service)
              echo "Notification service: may require SMTP test container in future"
              ;;
          esac

      - name: Set up JDK 21 for Java services
        if: ${{ matrix.service == 'order-service' || matrix.service == 'user-service' }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Download built test-utils from prepare job
        uses: actions/download-artifact@v4
        with:
          name: test-utils-m2
          path: ./.m2/repository/org/kunlecreates/test-utils

      - name: Ensure test-utils available in local Maven repo
        run: |
          # If prepare uploaded an artifact we copied it into workspace and now install into the runner's ~/.m2
          if [ -d ./.m2/repository/org/kunlecreates/test-utils ]; then
            mkdir -p "$HOME/.m2/repository/org/kunlecreates" || true
            cp -a ./.m2/repository/org/kunlecreates/test-utils "$HOME/.m2/repository/org/kunlecreates/" || true
          fi
          # If still missing (cache may have overwritten the install), build & install test-utils locally if the sources exist
          if [ ! -f "$HOME/.m2/repository/org/kunlecreates/test-utils/0.1.0/test-utils-0.1.0.jar" ] && [ -f ./services/test-utils/pom.xml ]; then
            echo "test-utils jar not present in local repo; building/installing from sources"
            mvn -B -DskipTests -f ./services/test-utils/pom.xml install || true
          fi


      - name: Run tests for ${{ matrix.service }}
        run: |
          # If prepare job produced test-utils, copy it into this runner's local Maven repo
          if [ -d ./.m2/repository/org/kunlecreates/test-utils ]; then
            echo "Found test-utils in workspace cache; installing into ~/.m2"
            mkdir -p $HOME/.m2/repository/org/kunlecreates || true
            cp -a ./.m2/repository/org/kunlecreates/test-utils $HOME/.m2/repository/org/kunlecreates/ || true
          fi
          set -e
          SERVICE_DIR="./services/${{ matrix.service }}"
          echo "Checking $SERVICE_DIR"
          if [ -f "$SERVICE_DIR/pom.xml" ]; then
            echo "Detected Maven service. Running mvn verify (includes integration tests)"
            mvn -B -f "$SERVICE_DIR" -Dapi.version=1.44 verify
          elif [ -f "$SERVICE_DIR/package.json" ]; then
            echo "Detected Node service. Installing and running npm test"
            pushd "$SERVICE_DIR"
            # Prefer npm ci when a lockfile exists, otherwise fall back to npm install
            if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
              npm ci
            else
              npm install
            fi
            npm test --silent || { echo 'npm test failed'; exit 1; }
            popd
          elif [ -f "$SERVICE_DIR/requirements.txt" ] || [ -f "$SERVICE_DIR/pyproject.toml" ]; then
            echo "Detected Python service. Running pytest from service dir"
            set -o pipefail
            # Run tests from inside the service directory so imports like `app` resolve
            pushd "$SERVICE_DIR"
            python3 -m pip install --upgrade pip || echo "pip upgrade failed"
            if [ -f requirements.txt ]; then
              python3 -m pip install -r requirements.txt || echo "pip install returned non-zero (continuing for debug)"
            fi
            # Ensure package imports resolve: include service dir on PYTHONPATH
            export PYTHONPATH="$(pwd)":$PYTHONPATH
            # Diagnostic removed: python sys.path printing was temporary
            # Run pytest with junit xml and capture logs; treat exit code 5 (no tests) as success
            rc=0
            pytest --maxfail=1 --junitxml=pytest-results.xml . > pytest.log 2>&1 || rc=$?
            if [ "$rc" -eq 5 ]; then
              echo "No tests collected for $SERVICE_DIR; continuing."
              rc=0
            fi
            if [ "$rc" -ne 0 ]; then
              echo "pytest failed with exit code $rc"
              cat pytest.log || true
              popd
              exit $rc
            fi
            popd
          else
            echo "No known test runner for $SERVICE_DIR; skipping"
          fi

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-artifacts
          path: |
            services/${{ matrix.service }}/pytest-results.xml
            services/${{ matrix.service }}/pytest.log
            services/${{ matrix.service }}/target/surefire-reports/**


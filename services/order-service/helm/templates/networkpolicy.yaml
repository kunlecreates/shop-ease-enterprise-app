apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: order-default-deny-ingress
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: order-service
  policyTypes:
    - Ingress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: order-allow-egress
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: order-service
  policyTypes:
    - Egress
  egress:
    # Allow DNS resolution
    - to:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: kube-system
      ports:
      - protocol: UDP
        port: 53
    # Allow traffic to notification-service for email notifications
    - to:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: shopease-notification
      ports:
      - protocol: TCP
        port: 80
      - protocol: TCP
        port: 8080
      - protocol: TCP
        port: 8084
    # Allow traffic to MSSQL database
    - to:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: mssql-system
      ports:
      - protocol: TCP
        port: 1433
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: order-allow-from-frontend-and-curl
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: order-service
  policyTypes:
    - Ingress
  ingress:
    # Allow kubelet health checks (from same namespace) on both service port and target port
    - ports:
        - protocol: TCP
          port: {{ .Values.service.port | default 80 }}
        - protocol: TCP
          port: {{ .Values.service.targetPort | default 8083 }}
    # Allow traffic from specified namespaces
    - from:
      {{- $global := (default (dict) .Values.global) }}
      {{- if and .Values.networkPolicy .Values.networkPolicy.allowedNamespaces }}
      {{- range $ns := .Values.networkPolicy.allowedNamespaces }}
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: {{ $ns | quote }}
      {{- end }}
      {{- else }}
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: {{ ($global.frontendNamespace | default "shopease-frontend") | quote }}
      {{- end }}
      - podSelector:
          matchLabels:
            run: curl-test
      ports:
        - protocol: TCP
          port: {{ .Values.service.port | default 80 }}
        - protocol: TCP
          port: {{ .Values.service.targetPort | default 8083 }}
